import React, { useState, useEffect } from 'react';
import OtpForm from './otp-form';
import CommonConstants from '../common/constants';
import Dropdown from '../common/components/dropdown';
import Util from '../common/util';
import GaConnector from '../common/components/ga-connector';
import apiService from '../common/services/apiService';


function GetStartedForm() {
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    phoneNumber: '',
    emailId: '',
    referralPropertyState: '',
    // userRole: {
    //   "roleDescription": "Borrower"
    // }
  });
  const [isSubmitBtnsEnabled, setIsSubmitBtnEnabled] = useState(false);
  const [errors, setErrors] = useState({ name: '', email: '' })
  const [allfieldValid, setAllFieldValid] = useState(false);
  const [respErrorMsg, setRespErrorMsg] = useState('');
  
  const [prevFormData, setPrevFormData] = useState(null);
  const [otpKey, setOtpKey] = useState(0); // Key for OtpForm component
  const util = new Util();
  const [user, setUser] = useState({});
  const [isOtpEnabled, setIsOtpEnabled] = useState(false);
  const [otpFieldVal, setOtpFieldVal] = useState('');
  
  const [stateList, setStateList] = useState([]);
  const constants = new CommonConstants();
  useEffect(() => {
    //to fetch approved states states == to uncoment once merged in newfi site
    // fetch('https://uat.newfi.com/rest/states/newfi_approved_states')
    apiService.get('/rest/states/newfi_approved_states').then(response => {
      if(!response.error){
        if(response?.data?.resultObject)
          setStateList(response?.data?.resultObject);
      }
    }).catch(error => { console.error('There was an error!', error); });
  }, [])

  const enableSubmitButton = (value, optValue) => {
    setOtpFieldVal(optValue);
    setIsSubmitBtnEnabled(value);
  }

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
    //format teh phone input
    if(e.target.name == 'phoneNumber'){
      setFormData({ ...formData, [e.target.name]: util.formatPhoneNumber(e.target.value) });
    }
  };

  const handleValidation = (e) => {
     //email validation
    const {name, value} = e.target;
    let errorMessage = {};
    if(name === 'emailId'){
      setErrors((prevErrors) => ({ ...prevErrors, email: util.validateEmail(e.target.value) ? '' : 'Please enter a valid email address.', }));
    }
    if(name === 'phoneNumber'){ 
      console.log(e.target.value.length)
      //validate field is not empty and length is 12
      errorMessage = (e.target.value.length < 14)? `Please enter valid 10 digit phone number.`:'';
      setErrors((prevErrors) => ({ ...prevErrors, [name]: errorMessage }));
    }

    if(name === 'referralPropertyState'){
      errorMessage = (e.target.value.toLowerCase() == 'property state')? `Please select property state.`: '';
      setErrors((prevErrors) => ({ ...prevErrors, [name]: errorMessage }));
    }
    
    //validate firstname and last name
    if(name === 'firstName' || name === 'lastName'){
      // change to camel case
      const camelCaseName = e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1);
      setFormData((prevData) => ({ ...prevData, [name]: camelCaseName }));
      errorMessage = util.validateName(camelCaseName)? '' : `Please enter a valid ${name}.`;
      setErrors((prevErrors) => ({ ...prevErrors, [name]: errorMessage }));
    }
    const allFieldPresent = Object.values(formData).every((value) => value !== '');
    if (allFieldPresent) {
      handleOTPGeneration();
    }

  }

  const handleOTPGeneration = () => {
    setRespErrorMsg('');
    const { phoneNumber, emailId } = formData;
    
    //get otp and enable otp fields
    
    // Check if either phone number or email is present and if they have changed
    const shouldGetOTP = (phoneNumber || emailId) && (
      phoneNumber !== prevFormData?.phoneNumber ||
      emailId !== prevFormData?.emailId
    );

    if (shouldGetOTP) {
      setAllFieldValid(false);
      const phoneNumberValue = phoneNumber.replace(/\D/g, "");
      // ${baseurl}/send_otp?recipientPhoneNumber=${phoneNumberValue}&emailId=${email}$
      apiService.post(`/rest/leadSource/send_otp?recipientPhoneNumber=${phoneNumberValue}&emailId=${emailId}`, {}).then((response) => {
        console.log(response);
        const result = response.data.resultObject;
        const error = response.data.error;
        if (!error) {
          if (result.otpStatus.toLowerCase() == 'delivered' || result.otpStatus.toLowerCase() == "success") {
            setOtpKey(prevKey => prevKey + 1);
            setAllFieldValid(true);
            // Store current formData for comparison in the next effect run
            setPrevFormData(formData);
          } else if (result.otpStatus === "FAILED" && result.message === "Duplicate Lead") {
            redirectTo404();
          } else {
            redirectTo404();
          }
        } else {
          const errorMessage = error.message.toLowerCase();
          if (errorMessage === "limit exceeded") {
            redirectTo404();
          } else if (errorMessage === "invalid request" || error.message.includes("not a valid phone number")) {
            setRespErrorMsg("Invalid phone number.");
          } else if (error.code == "400" || errorMessage === "invalid email") {
            setRespErrorMsg("Invalid email. Please enter valid email.");
          }
        }
      });
      
    }  
  }

  const handleGaConnectorUpdate = (data)=>{
    //update GA connector data
    setUser((prevUser) => ({
      ...prevUser,
      ...data
    }))
  }



  const handleSubmit = (e) => {
    e.preventDefault();
    let btnText = e.target.name;
    // Here you would typically make an API call to save the data
    console.log('Form data submitted:', formData);
    let LoanAppFormVO=new Object();
    let loan = new Object();
    let loanType = new Object();
    
    LoanAppFormVO.user = {
      "firstName": formData.firstName,
      "lastName": formData.lastName,
      "emailId": formData.emailId,
      "phoneNumber": formData.phoneNumber.replace(/\D/g, ""),
      "userRole": {
        "roleDescription": "Borrower"
      }
    };
    LoanAppFormVO.user.gaConnector = user.gaConnector;
    LoanAppFormVO.referralPropertyState = formData.referralPropertyState;
    LoanAppFormVO.leadSource = "Newfi Website";
    const {leadPurpose, loanManagerEmail} = constants.getLoanType(btnText);
    loanType.loanTypeCd = leadPurpose
    LoanAppFormVO.loanManagerEmail = loanManagerEmail;
    LoanAppFormVO.loanType = loanType;
    LoanAppFormVO.user.isGAConnector = true;;
    LoanAppFormVO.otp = otpFieldVal;
    LoanAppFormVO.isLeadFromNewfiWebsite = true;
    LoanAppFormVO.loan = loan;
    let reqData = new FormData();
    reqData.append('newfiWebsiteLeadDetails', JSON.stringify(LoanAppFormVO));
    //api call create lead : rest/leadSource/newfiWebsiteLeadDetails
    apiService.post('/rest/leadSource/newfiWebsiteLeadDetails', reqData, {headers: { 'Content-Type': 'multipart/form-data', }, cache: 'no-cache'}).then((response) => {
      let data = response.data;
      let loanTypeCd = LoanAppFormVO.loanType.loanTypeCd;
      if (data.resultObject !== null && data.resultObject !== "Failure") {
        let envUrl = data.resultObject.url.replace(/(loancenter\/)/, '');
    
        if ((data.resultObject.duplicateAccount != undefined && data.resultObject.duplicateLead != undefined) && (data.resultObject.duplicateAccount == true || data.resultObject.duplicateLead == true)) {
          window.setTimeout(() => {
            if (data.resultObject.duplicateAccount == true && (data.resultObject.duplicateLead != undefined && data.resultObject.duplicateLead == true)) {
              window.location.href = data.resultObject.url;
            } else if ((data.resultObject.duplicateLead != undefined && data.resultObject.duplicateLead == true) && data.resultObject.duplicateAccount == false) {
              if (LoanAppFormVO.loanType.loanTypeCd == 'PUR' || LoanAppFormVO.loanType.loanTypeCd == 'PURSTEPUP') {
                window.location.href = envUrl + "preapproval/#/" + data.resultObject.crmId + "/";
              } else if (LoanAppFormVO.loanType.loanTypeCd == 'REFNSAM') {
                window.location.href = envUrl + "equitychoice/#/" + data.resultObject.crmId + "/";
              } else {
                window.location.href = envUrl + "savingss/#/" + data.resultObject.crmId + "/";
              }
            }
      
          }, 5000);
        } else if (data.resultObject.otpStatus == 'FAILED' && data.resultObject.message == 'Duplicate Lead') {
          let redirectUrl;
          if (
            loanTypeCd === "PUR" ||
            loanTypeCd === "PURSTEPUP"
          ) {
            redirectUrl = `${envUrl}preapproval/#/${data.resultObject.crmId}/`;
          } else if (loanTypeCd === "REFNSAM") {
            redirectUrl = `${envUrl}equitychoice/#/${data.resultObject.crmId}/`;
          } else {
            redirectUrl = `${envUrl}savingss/#/${data.resultObject.crmId}/`;
          }
          window.location.href = redirectUrl;
        } else {
          if (LoanAppFormVO.loanType.loanTypeCd == 'PUR' || LoanAppFormVO.loanType.loanTypeCd == 'PURSTEPUP') {
            window.location.href = envUrl + "preapproval/#/" + data.resultObject.crmId + "/";
          } else if (LoanAppFormVO.loanType.loanTypeCd == 'REFNSAM') {
            window.location.href = envUrl + "equitychoice/#/" + data.resultObject.crmId + "/";
          } else {
            window.location.href = envUrl + "savingss/#/" + data.resultObject.crmId + "/";
          }
      
        }
      } else {
    
        if (data.error.message === "Invalid OTP, Please Enter Valid OTP") {
          setRespErrorMsg("Please enter valid verification code");
        } else if (["400", "Invalid email"].includes(data.error.code) || data.error.message.toLowerCase() === "invalid email") {
          setRespErrorMsg("Invalid email. Please enter valid email.");
          redirectTo404();
        } else if (data.error.message === "OTP Expired") {
          setRespErrorMsg("Verification code expired. Please generate again");
          
    
          // disable  submit buttons
          setIsSubmitBtnEnabled(false);
    
         //enable OTP Section
          setIsOtpEnabled(true);
          // OtpButton.style.display = "block";
          // verifyOtpButton.style.display = "block";
          // $(".fluentform").find(".help-message").remove();
          // verifiedtext.style.display = "none";
          // verifyOtpButton.setAttribute("disabled", "");
          // OtpButton.removeAttribute("disabled", "");
        } else if (data.error.message.toLowerCase() === "limit exceeded") {
          redirectTo404();
        } else {
          setRespErrorMsg(data.error.message);
          // $(".networkErrorMsg").hide();
          // OtpButton.style.display = "block";
          // verifyOtpButton.style.display = "block";
    
          //enable OTP Section
          setIsOtpEnabled(true);
    
          // disable  submit buttons
          setIsSubmitBtnEnabled(false);
          // if (savingsButton) {
          //   refinanceButton.setAttribute("disabled", "");
          //   savingsButton.setAttribute("disabled", "");
          // }
    
          // if (referalButton) {
          //   referalButton.setAttribute("disabled", "");
          // }
        }
      }
    }).catch(error => { console.error('There was an error!', error); });
    
  };

  const redirectTo404 = () => {
    setTimeout(() => {
      window.location.href = `${window.location.origin}/404`;
    }, 1000);
  };

  return (
    <div>
      <form className="get-started-form">
      <div className="flex gap30">
        <div className="form-group w-50">
          {/* <label htmlFor="firstName" className={formData.firstName ? 'hidden-label' : ''}>First Name</label> */}
          <input
            className="nf-control"
            type="text"
            id="firstName"
            name="firstName"
            placeholder="First Name"
            value={formData.firstName}
            onBlur={handleValidation}
            onChange={handleChange}
            required
          />
          {errors.firstName && <p style={{ color: 'red' }}>{errors.firstName}</p>}

        </div>
        <div className="form-group w-50">
          {/* <label htmlFor="lastName" className={formData.lastName ? 'hidden-label' : ''}>Last Name</label> */}
          <input
            className="nf-control"
            type="text"
            id="lastName"
            name="lastName"
            placeholder="Last Name"
            value={formData.lastName}
            onBlur={handleValidation}
            onChange={handleChange}
            required
          />
          {errors.lastName && <p className='error-text' style={{ color: 'red' }}>{errors.lastName}</p>}
        </div>
      </div>
      
        <div className="flex gap30">

          <div className="form-group w-50">
            <input
              className="nf-control"
              type="text"
              id="phoneNumber"
              name="phoneNumber"
              placeholder="(555) 555-5555"
              value={formData.phoneNumber}
              onChange={handleChange}
              onBlur={handleValidation}
              maxLength="14"
              required
            />
            {errors.phoneNumber && <p style={{ color: 'red' }}>{errors.phoneNumber}</p>}
          </div>
          <div className="form-group w-50">
            <Dropdown name="referralPropertyState" options={stateList} onChange={handleChange} onBlur={handleValidation} />
            {errors.referralPropertyState && <p className='error-text' style={{ color: 'red' }}>{errors.referralPropertyState}</p>}
          </div>
        </div>
      <div className="form-group w-50">
        {/* <label htmlFor="email">Email</label> */}
        <input
          className="nf-control"
          type="email"
          id="emailId"
          name="emailId"
          placeholder="Email"
          value={formData.email}
          onBlur={handleValidation}
          onChange={handleChange}
          required
        />
        {errors.email && <p className='error-text' style={{ color: 'red' }}>{errors.email}</p>}
      </div>
      
      {
        (allfieldValid || isOtpEnabled) && <OtpForm key={otpKey} isExpired={isOtpEnabled} formData={formData} onValueChange={enableSubmitButton}/>
      }
      { respErrorMsg && <div className="nf-error-common">{respErrorMsg}</div>}
      <div className="flex alignC gap30 justifyC">
      <button className="nf-btn nf-btn-priamry mT30" id='purchase' name='purchase' disabled={!(allfieldValid && isSubmitBtnsEnabled)} onClick={handleSubmit}>I'm Buying A Home</button>
      <button className="nf-btn nf-btn-priamry mT30" id='refinance' name='refinance' disabled={!(allfieldValid && isSubmitBtnsEnabled)} onClick={handleSubmit}>I'm Refinancing My Home</button>
      </div>
      <GaConnector onUpdate={handleGaConnectorUpdate}/>
    </form>
    
    </div>
    
  );
}

export default GetStartedForm;
